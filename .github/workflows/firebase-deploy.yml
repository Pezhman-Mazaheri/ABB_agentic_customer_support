# ============================================
# Firebase Deployment Workflow
# ============================================
# This workflow deploys the application to Firebase
# on push to main branch or manual trigger
# ============================================

name: Deploy to Firebase

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  FIREBASE_PROJECT_ID: abb-agentic-support-2026

jobs:
  # ============================================
  # Build and Test
  # ============================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'functions/requirements.txt'

      - name: Install Python dependencies
        run: |
          cd functions
          pip install -r requirements.txt

      - name: Lint Python code
        run: |
          pip install flake8
          flake8 functions/main.py --max-line-length=120 --ignore=E501,W503
        continue-on-error: true

      - name: Validate Firebase configuration
        run: |
          if [ ! -f "firebase.json" ]; then
            echo "Error: firebase.json not found"
            exit 1
          fi
          echo "Firebase configuration valid"

  # ============================================
  # Deploy to Firebase
  # ============================================
  deploy:
    name: Deploy to Firebase
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'functions/requirements.txt'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase Hosting
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          firebase deploy --only hosting:abb-agentic-support-2026 --token "$FIREBASE_TOKEN"

      - name: Deploy Cloud Functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          firebase deploy --only functions --token "$FIREBASE_TOKEN"
        continue-on-error: true  # Functions may need secrets to be set manually

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URL:** https://abb-agentic-support-2026.web.app" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Functions URL:** https://us-central1-abb-agentic-support-2026.cloudfunctions.net" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Preview for Pull Requests
  # ============================================
  preview:
    name: Preview Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy Preview
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          firebase hosting:channel:deploy pr-${{ github.event.number }} \
            --token "$FIREBASE_TOKEN" \
            --expires 7d
        continue-on-error: true

      - name: Comment Preview URL
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ”¥ Preview deployed! Check it out at: https://abb-agentic-support-2026--pr-${{ github.event.number }}.web.app'
            })
        continue-on-error: true

